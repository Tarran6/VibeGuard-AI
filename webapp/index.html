<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VibeGuard Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit';
    import { mainnet, bsc } from 'https://esm.sh/@reown/appkit/networks';

    // –¢–í–û–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 1: –õ–∏—á–Ω—ã–π –±—ã—Å—Ç—Ä—ã–π RPC —É–∑–µ–ª
    const opBNB = {
      id: 204,
      name: 'opBNB',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: { default: { http: ['https://opbnb-mainnet.nodereal.io/v1/409025609faa9f0b509ef6dbeffe2837'] } },
      blockExplorers: { default: { name: 'opBNBScan', url: 'https://opbnbscan.com' } }
    };

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const NONCE = urlParams.get('startapp') || urlParams.get('nonce');
    const API_URL = urlParams.get('api') || 'https://vibeguard-ai-production-7512.up.railway.app/webapp/connect';
    const tg = window.Telegram?.WebApp;

    if (tg) { tg.expand(); tg.ready(); }

    if (!NONCE) {
      document.body.innerHTML = '<div style="background:#0a0a0c;color:white;text-align:center;padding:50px;"><h2>‚ùå –û—à–∏–±–∫–∞</h2><p>–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p></div>';
      throw new Error('No nonce');
    }

    const modal = createAppKit({
      networks: [opBNB, bsc, mainnet],
      projectId: 'add9137cea1e48432cd4ba404f4a7443',
      metadata: {
        name: 'VibeGuard AI',
        description: 'Crypto Security Analysis',
        url: window.location.origin,
        icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
      },
      themeMode: 'dark'
    });

    // –¢–í–û–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 6: –ü—Ä–æ–≥—Ä–µ–≤ AppKit
    modal.getState();

    let isProcessing = false;
    window.globalSigner = null; // –î–æ–±–∞–≤–∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ –¥–ª—è Revoke

    // –¢–í–û–Ø –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!)
    async function signMessage() {
      if (isProcessing) return;
      isProcessing = true;

      // –¢–í–û–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 3: –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
      console.time('FullAuthProcess');
      const status = document.getElementById('status');
      
      try {
        status.textContent = '‚úçÔ∏è –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º...';

        // –¢–í–û–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø 2: –£–±—Ä–∞–Ω–∞ 1—Å –∑–∞–¥–µ—Ä–∂–∫–∞
        await new Promise(r => setTimeout(r, 100));

        let provider = modal.getWalletProvider() || modal.getState()?.provider;
        if (!provider) throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –≥–æ—Ç–æ–≤');

        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        window.globalSigner = signer; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
        const address = await signer.getAddress();

        const message = `VibeGuard verification: ${NONCE}`;
        const signature = await signer.signMessage(message);

        status.textContent = 'üì° –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address, signature, nonce: NONCE })
        });

        const result = await response.json();
        if (result.ok) {
          status.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
          console.timeEnd('FullAuthProcess');
          
          // –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –í–º–µ—Å—Ç–æ tg.close() –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–≤–æ–π –î–∞—à–±–æ—Ä–¥
          setTimeout(() => { 
              document.getElementById('auth-section').style.display = 'none';
              document.getElementById('dashboard-section').style.display = 'block';
              document.getElementById('wallet-address').textContent = `${address.substring(0,6)}...${address.substring(38)}`;
              window.renderMockApprovals(); // –†–µ–Ω–¥–µ—Ä–∏–º –º–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          }, 500);

        } else {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
      } catch (err) {
        status.textContent = '‚ùå ' + err.message;
        isProcessing = false;
      }
    }

    // –¢–í–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò
    window.connectWallet = async () => {
      const status = document.getElementById('status');
      const btn = document.querySelector('.btn-main'); 
      
      status.style.display = 'block';
      const state = modal.getState();

      if (state?.address && state?.isConnected) {
        await signMessage();
      } else {
        status.textContent = 'üíé –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫...';
        await modal.open();
        
        const unsubscribe = modal.subscribeAccount(async (newState) => {
          if (newState.isConnected && newState.address && !isProcessing) {
            unsubscribe();
            
            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –∑–µ–ª–µ–Ω—É—é
            status.textContent = '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è';
            btn.style.background = 'linear-gradient(135deg, #10b981, #059669)'; 
            btn.innerHTML = '‚úçÔ∏è –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ü–æ–¥–ø–∏—Å–∞—Ç—å';
            
            // –í–µ—à–∞–µ–º —á–∏—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é –±–µ–∑ –∫—Ä–∞—à–µ–π
            btn.onclick = async () => {
                btn.innerHTML = '‚è≥ –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏...';
                // –ú–´ –£–î–ê–õ–ò–õ–ò window.location.href = "wc:" –ò –£–ë–ò–õ–ò –£–¢–ö–£!
                await signMessage();
            };
          }
        });
      }
    };

    // ==========================================
    // –õ–û–ì–ò–ö–ê –î–ê–®–ë–û–†–î–ê (–í–∏–∑—É–∞–ª –∏ –û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–æ–≤)
    // ==========================================
    window.renderMockApprovals = () => {
        const list = document.getElementById('approvals-list');
        list.innerHTML = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        list.innerHTML = '<div style="text-align: center; padding: 20px; color: #8e8e93;">üîç –°–∫–∞–Ω–∏—Ä—É–µ–º approve —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...</div>';
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å API
        fetchApprovals();
    }

    async function fetchApprovals() {
        try {
            const response = await fetch('https://vibeguard-ai-production-7512.up.railway.app/webapp/approvals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: window.globalSigner.address })
            });
            
            const result = await response.json();
            const list = document.getElementById('approvals-list');
            
            if (result.ok && result.approvals) {
                if (result.approvals.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #10b981;">‚úÖ –û–ø–∞—Å–Ω—ã—Ö approve –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }
                
                list.innerHTML = '';
                result.approvals.forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'approval-item';
                    item.style.borderLeftColor = app.risk === 'high' ? '#ef4444' : '#f59e0b';
                    
                    const riskText = app.risk === 'high' ? 'üö® –í–´–°–û–ö–ò–ô –†–ò–°–ö' : '‚ö†Ô∏è –°–†–ï–î–ù–ò–ô –†–ò–°–ö';
                    const risksList = app.risks && app.risks.length > 0 ? app.risks.join(', ') : '–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π approve';
                    
                    item.innerHTML = `
                        <div class="approval-info">
                            <strong>${app.tokenName} (${app.tokenSymbol})</strong>
                            <span class="spender">–î–æ—Å—Ç—É–ø —É: ${app.spenderAddress.substring(0,8)}...${app.spenderAddress.substring(36)}</span>
                            <span class="amount">–õ–∏–º–∏—Ç: ${app.amountFormatted}</span>
                            <span class="risk-badge ${app.risk}">${riskText}</span>
                            ${app.risks && app.risks.length > 0 ? `<span class="risks">‚ö†Ô∏è ${risksList}</span>` : ''}
                        </div>
                        <button class="btn-revoke" onclick="window.revokeAccess('${app.tokenAddress}', '${app.spenderAddress}')">Revoke</button>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
            }
        } catch (error) {
            console.error('fetchApprovals error:', error);
            document.getElementById('approvals-list').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>';
        }
    }

    window.revokeAccess = async (tokenAddress, spenderAddress) => {
        if (!window.globalSigner) return alert("–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
        try {
            const abi = ["function approve(address spender, uint256 amount) public returns (bool)"];
            const contract = new ethers.Contract(tokenAddress, abi, window.globalSigner);
            const tx = await contract.approve(spenderAddress, 0);
            alert(`–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ—à–µ–ª–µ–∫!\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –µ—ë.`);
            await tx.wait();
            alert("‚úÖ –î–æ—Å—Ç—É–ø —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω!");
            document.getElementById('approvals-list').innerHTML = '<p style="color:#10b981;">‚úÖ –£–≥—Ä–æ–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–∞—à –∫–æ—à–µ–ª–µ–∫ —á–∏—Å—Ç.</p>';
        } catch (error) {
            console.error(error);
            alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        }
    };
  </script>

  <style>
    body { font-family: -apple-system, system-ui, sans-serif; background: #0a0a0c; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .container { background: #121216; border-radius: 24px; padding: 32px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #26262c; }
    .logo { font-size: 50px; margin-bottom: 10px; }
    h2 { margin: 10px 0; font-size: 24px; }
    p { color: #8e8e93; font-size: 14px; margin-bottom: 25px; }
    .btn-main { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 16px; padding: 18px; width: 100%; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-main:active { transform: scale(0.98); }
    #status { margin-top: 20px; color: #6366f1; display: none; font-size: 14px; font-weight: bold; }

    /* Dashboard Styles */
    #dashboard-section { display: none; text-align: left; }
    .wallet-badge { background: #1e1e24; padding: 8px 16px; border-radius: 20px; display: inline-block; font-family: monospace; font-size: 14px; margin-bottom: 20px; border: 1px solid #333; }
    .approval-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a20; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #ef4444; }
    .approval-info { display: flex; flex-direction: column; }
    .approval-info strong { font-size: 16px; margin-bottom: 4px; color: #ef4444; }
    .approval-info .amount { font-size: 12px; color: #ef4444; margin-top: 4px; font-weight: bold;}
    .section-title { font-size: 18px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;}
    .btn-revoke { background: #ef4444; color: white; border: none; border-radius: 8px; padding: 10px 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-revoke:active { background: #dc2626; transform: scale(0.95); }
    .risk-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; font-weight: bold; }
    .risk-badge.high { background: #ef4444; color: white; }
    .risk-badge.medium { background: #f59e0b; color: white; }
    .risks { font-size: 11px; color: #f59e0b; margin-top: 4px; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    
    <div id="auth-section">
        <div class="logo">üõ°Ô∏è</div>
        <h2>VibeGuard AI</h2>
        <p>–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–æ—à–µ–ª—å–∫–∞</p>
        <button class="btn-main" onclick="connectWallet()">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
        <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div id="dashboard-section">
        <div style="text-align: center;">
            <div class="wallet-badge">üëõ <span id="wallet-address">0x...</span></div>
        </div>
        
        <div class="section-title">üö® –ù–∞–π–¥–µ–Ω—ã —É–≥—Ä–æ–∑—ã</div>
        <p style="font-size: 12px; color: #a1a1aa;">–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–∏–º —Ç–æ–∫–µ–Ω–∞–º.</p>
        
        <div id="approvals-list"></div>

        <button class="btn-main" style="background: #333; margin-top: 20px;" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    </div>

  </div>
</body>
</html>
