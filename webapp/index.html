<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VibeGuard Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit';
    import { mainnet, bsc } from 'https://esm.sh/@reown/appkit/networks';

    const opBNB = {
      id: 204,
      name: 'opBNB',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: { default: { http: ['https://opbnb-rpc.publicnode.com'] } },
      blockExplorers: { default: { name: 'opBNBScan', url: 'https://opbnbscan.com' } }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const NONCE = urlParams.get('startapp') || urlParams.get('nonce');
    const tg = window.Telegram?.WebApp;

    if (tg) { tg.expand(); tg.ready(); }

    const modal = createAppKit({
      networks: [opBNB, bsc, mainnet],
      projectId: 'add9137cea1e48432cd4ba404f4a7443',
      metadata: {
        name: 'VibeGuard AI',
        description: 'Crypto Security Analysis',
        url: window.location.origin,
        icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
      },
      themeMode: 'dark'
    });

    let isProcessing = false;

    async function signMessage() {
      if (isProcessing) return;
      isProcessing = true;
      
      const status = document.getElementById('status');
      try {
        status.textContent = '‚úçÔ∏è –ü–æ–¥–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ—à–µ–ª—å–∫–µ...';
        
        await new Promise(r => setTimeout(r, 1000));
        let provider = modal.getWalletProvider() || modal.getState()?.provider;
        
        if (!provider) throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å.');

        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        const address = await signer.getAddress();

        const message = `VibeGuard verification: ${NONCE}`;
        const signature = await signer.signMessage(message);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º nonce –≤–º–µ—Å—Ç–µ —Å –ø–æ–¥–ø–∏—Å—å—é
        tg.sendData(JSON.stringify({
          address: address,
          signature: signature,
          nonce: NONCE 
        }));

        status.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è...';
        setTimeout(() => tg.close(), 1200);

      } catch (err) {
        status.textContent = '‚ùå ' + err.message;
        isProcessing = false;
        console.error(err);
      }
    }

    window.connectWallet = async () => {
      const status = document.getElementById('status');
      status.style.display = 'block';
      
      const state = modal.getState();
      
      if (state?.address && state?.isConnected) {
        await signMessage();
      } else {
        status.textContent = 'üíé –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞...';
        await modal.open();
        
        const unsubscribe = modal.subscribeAccount(async (newState) => {
          if (newState.isConnected && newState.address && !isProcessing) {
            unsubscribe();
            await signMessage();
          }
        });
      }
    };
  </script>
  <style>
    body { font-family: sans-serif; background: #0a0a0c; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .container { background: #121216; border-radius: 24px; padding: 32px; width: 90%; max-width: 340px; text-align: center; border: 1px solid #26262c; }
    .btn-main { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 16px; padding: 18px; width: 100%; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-main:active { transform: scale(0.98); }
    #status { margin-top: 20px; color: #6366f1; display: none; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div style="font-size: 50px; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h2>VibeGuard AI</h2>
    <p style="color: #8e8e93; font-size: 14px; margin-bottom: 25px;">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ MetaMask –∏–ª–∏ OKX</p>
    <button class="btn-main" onclick="connectWallet()">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
  <div id="dashboard-section" style="display: none; text-align: left;">
        <div style="text-align: center;"><div class="wallet-badge">üëõ <span id="wallet-address">0x...</span></div></div>
        <div style="font-size: 18px; margin-bottom: 5px; font-weight: bold;">üõ°Ô∏è –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ—Å—Ç—É–ø—ã</div>
        <p style="font-size: 12px; color: #8e8e93; margin-bottom: 15px;">–¢–æ–ª—å–∫–æ 1 –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω.</p>
        <div id="approvals-list"></div>
        <button class="btn-main" style="background: #222; margin-top: 20px;" onclick="window.location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
</body>
</html>
