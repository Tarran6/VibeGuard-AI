<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>VibeGuard Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit';
    import { mainnet, bsc } from 'https://esm.sh/@reown/appkit/networks';

    const opBNB = {
      id: 204,
      name: 'opBNB Mainnet',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: { default: { http: ['https://opbnb-rpc.publicnode.com'] } },
      blockExplorers: { default: { name: 'opBNBScan', url: 'https://opbnbscan.com' } }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const NONCE = urlParams.get('startapp') || urlParams.get('nonce') || '';
    
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô ID –ò–ó DASHBOARD REOWN –ù–ê–í–°–ï–ì–î–ê
    const MY_PROJECT_ID = 'add9137cea1e48432cd4ba404f4a7443'; 

    const tg = window.Telegram?.WebApp;

    if (!tg || !tg.sendData) {
      document.body.innerHTML = '<div class="card"><h2>üõ°Ô∏è VibeGuard</h2><p class="muted">–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ @VibeGuard_AI_bot</p></div>';
    } else {
      tg.expand();
      tg.ready();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª–∫–∏
    const modal = createAppKit({
      networks: [opBNB, bsc, mainnet],
      projectId: MY_PROJECT_ID,
      metadata: {
        name: 'VibeGuard AI',
        description: '–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è Web3 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
        url: window.location.origin,
        icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
      },
      themeMode: 'dark'
    });

    window.connectWallet = async () => {
      const status = document.getElementById('status');
      status.style.display = 'block';
      
      try {
        // –ï—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–º –ø–æ–¥–ø–∏—Å–∞—Ç—å
        if (modal.getIsConnectedState()) {
            await proceedToSign();
            return;
        }

        await modal.open();

        // –ñ–¥–µ–º —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–Ω–Ω–µ–∫—Ç–∞
        modal.subscribeEvents(async (event) => {
          if (event.data.event === 'CONNECT_SUCCESS') {
            await proceedToSign();
          }
        });
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      }
    };

    async function proceedToSign() {
      const status = document.getElementById('status');
      status.textContent = '–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ—à–µ–ª—å–∫–µ...';
      
      try {
        const address = modal.getAddress();
        const provider = modal.getWalletProvider();
        
        if (!provider) throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –ø—Ä–æ–≤–∞–π–¥–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');

        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        
        // –í–∞–∂–Ω–æ: Boinkers –∏ –¥—Ä—É–≥–∏–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —á–µ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const signature = await signer.signMessage(`VibeGuard verification: ${NONCE}`);

        tg.sendData(JSON.stringify({
          address: address,
          signature: signature,
          nonce: NONCE
        }));

        status.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –±–æ—Ç–∞...';
        setTimeout(() => tg.close(), 1200);
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏: ' + e.message);
        status.style.display = 'none';
      }
    }
  </script>

  <style>
    /* –¢–≤–æ–∏ —Å—Ç–∏–ª–∏ –æ—Ç–ª–∏—á–Ω—ã–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å */
    body { font-family: sans-serif; background: #0f0f1f; color: #e0e0ff; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
    .card { background: #16162a; border-radius: 28px; padding: 40px; width: 100%; max-width: 360px; text-align: center; border: 1px solid #4a4a6a; }
    .btn-connect { width: 100%; padding: 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 20px; font-weight: 700; cursor: pointer; }
    #status { display: none; margin-top: 20px; color: #67e8f9; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üõ°Ô∏è VibeGuard</h2>
    <p style="color: #a0a0cc; margin-bottom: 30px;">–ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
    <button class="btn-connect" onclick="connectWallet()">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
    <div id="status">–ó–∞–ø—É—Å–∫...</div>
  </div>
</body>
</html>
