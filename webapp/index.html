<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>VibeGuard Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Reown AppKit (WalletConnect) -->
  <script type="module">
    import { createAppKit } from 'https://unpkg.com/@reown/appkit@1.6.0/dist/esm/index.js'
    import { mainnet, bsc } from 'https://unpkg.com/@reown/appkit/networks@1.6.0/dist/esm/index.js'

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ç—å opBNB (chainId 204)
    const opBNB = {
      id: 204,
      name: 'opBNB Mainnet',
      nativeCurrency: {
        name: 'BNB',
        symbol: 'BNB',
        decimals: 18
      },
      rpcUrls: {
        default: { http: ['https://opbnb-rpc.publicnode.com'] } // –ø—É–±–ª–∏—á–Ω—ã–π RPC, –∫–ª—é—á –Ω–µ –Ω—É–∂–µ–Ω
      },
      blockExplorers: {
        default: { name: 'opBNBScan', url: 'https://opbnbscan.com' }
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º nonce –∏–∑ Telegram WebApp initDataUnsafe.start_param
    const tg = window.Telegram?.WebApp;
    let NONCE = '';

    if (tg?.initDataUnsafe?.start_param) {
      NONCE = tg.initDataUnsafe.start_param;
    } else {
      // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –±–µ—Ä—ë–º –∏–∑ URL (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
      const urlParams = new URLSearchParams(window.location.search);
      NONCE = urlParams.get('nonce') || '';
    }

    // –ï—Å–ª–∏ nonce –Ω–∞–π–¥–µ–Ω, –æ—á–∏—â–∞–µ–º URL –æ—Ç –Ω–µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏–ª—Å—è)
    if (NONCE) {
      window.history.replaceState(null, '', window.location.pathname);
    }

    // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª–∫—É WalletConnect
    const modal = createAppKit({
      projectId: 'add9137cea1e48432cd4ba404f4a7443', // –í–∞—à REOWN_PROJECT_ID
      networks: [opBNB, bsc, mainnet],
      metadata: {
        name: 'VibeGuard AI',
        description: 'Neural Security Sentinel for opBNB',
        url: window.location.origin,
        icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
      },
      themeMode: 'dark',
      allWallets: 'SHOW' // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
    window.connectWallet = async () => {
      if (!NONCE) {
        alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ /connect –∑–∞–Ω–æ–≤–æ.');
        return;
      }

      if (!tg?.sendData) {
        alert('–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.');
        return;
      }

      try {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ –∫–æ—à–µ–ª—å–∫–∞
        await modal.open();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è WalletConnect: ' + e.message);
      }
    };

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    modal.subscribeProvider(async (state) => {
      if (state.provider && state.address) {
        try {
          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å nonce
          const signature = await state.provider.request({
            method: 'personal_sign',
            params: [`VibeGuard verification: ${NONCE}`, state.address]
          });

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–æ—Ç–∞
          tg.sendData(JSON.stringify({
            address: state.address,
            signature: signature
          }));

          document.getElementById('status').style.display = 'block';
          document.getElementById('status').textContent = '‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω–æ! –ó–∞–∫—Ä—ã–≤–∞–µ–º...';
          setTimeout(() => tg.close(), 1000);
        } catch (e) {
          alert('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏: ' + e.message);
        }
      }
    });
  </script>

  <style>
    body { font-family: sans-serif; background: #0d0d1a; color: #e8e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; text-align: center; }
    .card { background: #16162a; border: 1px solid #2a2a4a; border-radius: 20px; padding: 24px; width: 100%; max-width: 320px; }
    .btn { display: block; width: 100%; padding: 16px; margin: 12px 0; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 15px; background: #7c5cfc; color: white; }
    .muted { color: #8888aa; font-size: 13px; margin-top: 20px; }
    #status { display: none; margin-top: 20px; font-weight: bold; color: #4fc3f7; }
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">üõ°Ô∏è VibeGuard</h2>
    <p class="muted">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ª—é–±–æ–π –∫–æ—à–µ–ª—ë–∫</p>
    
    <button class="btn" onclick="connectWallet()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
    
    <div id="status">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
  </div>
  
  <p class="muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏ (MetaMask, Trust, Coinbase, OKX –∏ –¥—Ä.)</p>

  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ Telegram
    (function() {
      const tg = window.Telegram?.WebApp;
      if (!tg || !tg.sendData) {
        document.body.innerHTML = '<div class="card"><h2>üõ°Ô∏è VibeGuard</h2><p class="muted">–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram: –Ω–∞–∂–º–∏—Ç–µ ¬´Connect Wallet¬ª –≤ @VibeGuard_AI_bot</p></div>';
      } else {
        tg.expand();
      }
    })();
  </script>
</body>
</html>
