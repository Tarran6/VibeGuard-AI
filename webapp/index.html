<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VibeGuard Auth</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit';
    import { mainnet, bsc } from 'https://esm.sh/@reown/appkit/networks';

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è opBNB
    const opBNB = {
      id: 204,
      name: 'opBNB',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: { default: { http: ['https://opbnb-rpc.publicnode.com'] } },
      blockExplorers: { default: { name: 'opBNBScan', url: 'https://opbnbscan.com' } }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const NONCE = urlParams.get('nonce') || urlParams.get('startapp') || 'test_session';
    const tg = window.Telegram?.WebApp;

    if (tg) {
      tg.expand();
      tg.ready();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Reown AppKit
    const modal = createAppKit({
      networks: [opBNB, bsc, mainnet],
      projectId: 'add9137cea1e48432cd4ba404f4a7443',
      metadata: {
        name: 'VibeGuard AI',
        description: 'Crypto Security Analysis',
        url: 'https://vibe-guard-ai.vercel.app',
        icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
      },
      themeMode: 'dark'
    });

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏
    window.connectWallet = async () => {
      const status = document.getElementById('status');
      status.style.display = 'block';
      
      try {
        // 1. –ï—Å–ª–∏ —É–∂–µ –∑–∞–∫–æ–Ω–Ω–µ–∫—á–µ–Ω—ã ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º
        if (modal.getIsConnected()) {
          await signVibeMessage();
          return;
        }

        // 2. –ò–Ω–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ (–∫–∞–∫ –≤ Boinkers)
        status.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫...';
        await modal.open();

        // –°–ª—É—à–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const unsubscribe = modal.subscribeEvents(async (event) => {
          if (event.data.event === 'CONNECT_SUCCESS') {
            unsubscribe();
            await signVibeMessage();
          }
        });

      } catch (err) {
        status.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function signVibeMessage() {
      const status = document.getElementById('status');
      status.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å –≤ –∫–æ—à–µ–ª—å–∫–µ...';

      try {
        const provider = modal.getWalletProvider();
        if (!provider) throw new Error('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');

        // –ú–∞–≥–∏—á–µ—Å–∫–∏–π –ø–∏–Ω–æ–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
          setTimeout(() => { window.location.href = "wc:"; }, 100);
        }

        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        const address = await signer.getAddress();
        
        const message = `VibeGuard Auth\nNonce: ${NONCE}`;
        const signature = await signer.signMessage(message);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
        if (tg) {
          tg.sendData(JSON.stringify({
            address: address,
            signature: signature,
            nonce: NONCE,
            method: 'reown'
          }));
          
          status.textContent = '‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
          setTimeout(() => tg.close(), 1000);
        }
      } catch (err) {
        status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        console.error(err);
      }
    }
  </script>

  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      background: #0a0a0c;
      color: white;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      background: #121216;
      border: 1px solid #26262c;
      border-radius: 24px;
      padding: 32px;
      width: 90%;
      max-width: 340px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .logo { font-size: 50px; margin-bottom: 10px; }
    h2 { margin: 10px 0; font-size: 24px; }
    p { color: #8e8e93; font-size: 14px; margin-bottom: 30px; }
    .btn-main {
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 16px;
      padding: 18px;
      width: 100%;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .btn-main:active { transform: scale(0.98); }
    #status {
      margin-top: 20px;
      font-size: 13px;
      color: #6366f1;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üõ°Ô∏è</div>
    <h2>VibeGuard</h2>
    <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
    
    <button class="btn-main" onclick="connectWallet()">
      üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫
    </button>

    <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
  </div>
</body>
</html>
