<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VibeGuard Auth</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit';
    import { mainnet, bsc } from 'https://esm.sh/@reown/appkit/networks';

    const opBNB = {
      id: 204,
      name: 'opBNB',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: { default: { http: ['https://opbnb-rpc.publicnode.com'] } },
      blockExplorers: { default: { name: 'opBNBScan', url: 'https://opbnbscan.com' } }
    };

    // –ü–æ–ª—É—á–∞–µ–º nonce –∏–∑ URL (startapp –∏–ª–∏ nonce)
    const urlParams = new URLSearchParams(window.location.search);
    const NONCE = urlParams.get('startapp') || urlParams.get('nonce');
    const tg = window.Telegram?.WebApp;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ Telegram
    if (!tg || !tg.sendData) {
      document.body.innerHTML = '<div style="background:#0a0a0c;color:white;text-align:center;padding:50px;"><h2>üõ°Ô∏è VibeGuard</h2><p>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.</p></div>';
      throw new Error('Not in Telegram');
    }

    tg.expand();
    tg.ready();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è nonce
    if (!NONCE) {
      document.body.innerHTML = '<div style="background:#0a0a0c;color:white;text-align:center;padding:50px;"><h2>‚ùå –û—à–∏–±–∫–∞</h2><p>–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ /connect –≤ –±–æ—Ç–µ –∑–∞–Ω–æ–≤–æ.</p></div>';
      throw new Error('No nonce provided');
    }

    // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª–∫—É WalletConnect
    let modal;
    try {
      modal = createAppKit({
        networks: [opBNB, bsc, mainnet],
        projectId: 'add9137cea1e48432cd4ba404f4a7443',
        metadata: {
          name: 'VibeGuard AI',
          description: 'Crypto Security Analysis',
          url: window.location.origin,
          icons: ['https://raw.githubusercontent.com/Tarran6/VibeGuard-AI/main/assets/logo.png']
        },
        themeMode: 'dark'
      });
      console.log('AppKit —Å–æ–∑–¥–∞–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è AppKit:', e);
      document.body.innerHTML = '<div style="background:#0a0a0c;color:white;text-align:center;padding:50px;"><h2>‚ùå –û—à–∏–±–∫–∞</h2><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WalletConnect.</p></div>';
      throw e;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
    async function signMessage() {
      const status = document.getElementById('status');
      try {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const provider = modal.getWalletProvider();
        if (!provider) {
          // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ getState
          const state = modal.getState();
          console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ AppKit:', state);
          
          if (state?.provider) {
            console.log('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ getState');
            const ethersProvider = new ethers.BrowserProvider(state.provider);
            const signer = await ethersProvider.getSigner();
            const address = await signer.getAddress();
            const message = `VibeGuard verification: ${NONCE}`;
            const signature = await signer.signMessage(message);
            
            tg.sendData(JSON.stringify({ address, signature }));
            status.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä—ã–≤–∞–µ–º...';
            setTimeout(() => tg.close(), 1000);
            return;
          }
          
          throw new Error('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        }

        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        const address = await signer.getAddress();

        const message = `VibeGuard verification: ${NONCE}`;
        const signature = await signer.signMessage(message);

        tg.sendData(JSON.stringify({
          address: address,
          signature: signature
        }));

        status.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä—ã–≤–∞–µ–º...';
        setTimeout(() => tg.close(), 1000);
      } catch (err) {
        status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏: ' + err.message;
        console.error(err);
      }
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ—à–µ–ª—ë–∫ —Å –Ω–∞–¥—ë–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    window.connectWallet = async () => {
      const status = document.getElementById('status');
      status.style.display = 'block';

      try {
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const state = modal.getState();
        const hasRealConnection = state?.address && state?.isConnected;

        if (hasRealConnection) {
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å, –∏–¥—ë–º –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å
          status.textContent = '–ö–æ—à–µ–ª—ë–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å...';
          await signMessage();
          return;
        }

        // –ù–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–æ—à–µ–ª—å–∫–∞
        status.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–æ—à–µ–ª—å–∫–∞...';
        await modal.open();

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–µ —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const unsubscribe = modal.subscribeAccount(async (newState) => {
          if (newState.address && newState.isConnected) {
            unsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è —Å—Ä–∞–∑—É
            status.textContent = '–ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å...';
            await signMessage();
          }
        });

      } catch (err) {
        status.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
        console.error(err);
      }
    };
  </script>

  <style>
    body { font-family: -apple-system, system-ui, sans-serif; background: #0a0a0c; color: white; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
    .container { background: #121216; border: 1px solid #26262c; border-radius: 24px; padding: 32px; width: 90%; max-width: 340px; text-align: center; }
    .logo { font-size: 50px; margin-bottom: 10px; }
    h2 { margin: 10px 0; font-size: 24px; }
    p { color: #8e8e93; font-size: 14px; margin-bottom: 30px; }
    .btn-main { background: #6366f1; color: white; border: none; border-radius: 16px; padding: 18px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
    .btn-main:active { transform: scale(0.98); }
    #status { margin-top: 20px; font-size: 13px; color: #6366f1; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üõ°Ô∏è</div>
    <h2>VibeGuard</h2>
    <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
    <button class="btn-main" onclick="connectWallet()">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</body>
</html>
